<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanji Pronunciation Game</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .section { display: none; margin-bottom: 30px; }
        .section.active { display: block; }
        input, button { font-size: 16px; padding: 10px; margin: 5px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; }
        .kanji-cell { font-size: 24px; font-family: 'Noto Sans JP', sans-serif; }
        .score { font-size: 24px; font-weight: bold; margin: 20px 0; }
        .feedback { font-size: 20px; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .correct { background-color: #d4edda; color: #155724; }
        .wrong { background-color: #f8d7da; color: #721c24; }
        button { background: #007bff; color: white; border: none; cursor: pointer; border-radius: 5px; }
        button:hover { background: #0056b3; }
        .delete-btn { background: #dc3545; }
        .delete-btn:hover { background: #c82333; }
        .add-btn { background: #28a745; }
        .add-btn:hover { background: #218838; }
        .export-btn { background: #17a2b8; }
        .export-btn:hover { background: #138496; }
        .input-row input { width: 100%; font-size: 20px; }
        #csvFileInput { display: none; }
        .csv-controls { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0; }
    </style>
</head>
<body>
    <!-- Kanji List Management Section -->
    <div id="inputSection" class="section active">
        <h2>üìù Kanji List Management</h2>
        <p>Add new kanji or remove mastered ones. Your list persists in sessionStorage.</p>
        
        <!-- CSV Import/Export Controls -->
        <div class="csv-controls">
            <h3>üìä CSV Import/Export</h3>
            <p>Export to edit in Excel/Google Sheets, then import back.</p>
            <button class="export-btn" onclick="exportToCSV()">üì§ Export to CSV</button>
            <label for="csvFileInput" class="export-btn" style="cursor: pointer; display: inline-block;">üì• Import CSV</label>
            <input type="file" id="csvFileInput" accept=".csv" />
        </div>
        
        <table id="kanjiListTable">
            <thead>
                <tr>
                    <th>Kanji</th>
                    <th>Romaji</th>
                    <th>Stats</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div style="margin: 20px 0;">
            <input type="text" id="newKanjiInput" placeholder="Enter new kanji (e.g. È£ü„Åπ„Çã)" style="width: 300px;">
            <input type="text" id="newRomajiInput" placeholder="Romaji (e.g. taberu)" style="width: 200px;">
            <button class="add-btn" onclick="addNewKanji()">‚ûï Add Kanji</button>
        </div>
        <div>
            <button onclick="loadRomajiEditTable()">‚úèÔ∏è Edit Romaji ‚Üí Start Game</button>
            <button onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
        </div>
    </div>

    <!-- Romaji Edit Section -->
    <div id="editSection" class="section">
        <h2>2. Edit Romaji</h2>
        <table id="editTable">
            <thead>
                <tr>
                    <th>Kanji</th>
                    <th>Romaji</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <button onclick="saveEditedList()">Save ‚Üí Start Game</button>
        <button onclick="goBackToInput()">‚Üê Back to List</button>
    </div>

    <!-- Game Section -->
    <div id="gameSection" class="section">
        <h2>Kanji Pronunciation Quiz</h2>
        <div class="score" id="scoreDisplay">Score: 0 / 0 (0%)</div>
        <div id="questionArea">
            <div id="kanjiDisplay" class="kanji-cell" style="font-size: 48px; text-align: center; margin: 30px 0;"></div>
            <input type="text" id="answerInput" placeholder="Type romaji here (e.g. taberu)" style="width: 70%; text-align: center;">
            <br><br>
            <button onclick="checkAnswer()">Submit Answer</button>
            <button onclick="speakCurrentKanji()">üîä Hear Again</button>
            <button onclick="nextQuestion()">Skip</button>
        </div>
        <div id="feedbackArea"></div>
        <div style="margin-top: 20px;">
            <button onclick="showStats()">üìä Stats</button>
            <button onclick="goBackToInput()">‚Üê Manage List</button>
        </div>
    </div>

    <!-- Stats Modal -->
    <div id="statsModal" style="position: fixed; top: 20%; left: 20%; width: 60%; background: white; border: 2px solid #ccc; padding: 20px; display: none; z-index: 1000;">
        <h3>Session Stats</h3>
        <div id="statsContent"></div>
        <button onclick="hideStats()">Close</button>
    </div>

    <script>
        let gameData = [];

        // Section navigation
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
        }

        function goBackToInput() {
            showSection('inputSection');
            loadKanjiListTable();
        }

        // CSV Export/Import Functions
        function exportToCSV() {
            if (gameData.length === 0) {
                return alert('No data to export!');
            }
            
            const csvContent = [
                ['kanji', 'romaji', 'correct', 'wrong'], // Header
                ...gameData.map(item => [
                    `"${item.kanji}"`,
                    `"${item.romaji || ''}"`,
                    item.correct,
                    item.wrong
                ])
            ].map(row => row.join(',')).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `kanji-list-${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        document.getElementById('csvFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                const importedData = parseCSV(csv);
                
                if (importedData.length === 0) {
                    return alert('No valid data found in CSV!');
                }
                
                // Merge with existing data (avoid duplicates by kanji)
                const existingKanji = gameData.map(item => item.kanji);
                const newItems = importedData.filter(item => !existingKanji.includes(item.kanji));
                
                gameData.push(...newItems);
                sessionStorage.setItem('kanjiGameItems', JSON.stringify(gameData));
                loadKanjiListTable();
                
                alert(`Imported ${newItems.length} new kanji. Total: ${gameData.length}`);
            };
            reader.readAsText(file, 'UTF-8');
        });

        function parseCSV(csv) {
            const lines = csv.split('\n').filter(line => line.trim());
            const items = [];
            
            for (let i = 1; i < lines.length; i++) { // Skip header
                const cols = lines[i].split(',').map(col => col.trim().replace(/^"|"$/g, ''));
                if (cols.length >= 1 && cols[0]) {
                    items.push({
                        kanji: cols[0],
                        romaji: cols[1] || '',
                        correct: parseInt(cols[2]) || 0,
                        wrong: parseInt(cols[3]) || 0
                    });
                }
            }
            return items;
        }

        // 1. Kanji List Management
        function loadKanjiListTable() {
            const stored = sessionStorage.getItem('kanjiGameItems');
            gameData = stored ? JSON.parse(stored) : [];
            
            const tbody = document.querySelector('#kanjiListTable tbody');
            tbody.innerHTML = '';
            
            gameData.forEach((item, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td class="kanji-cell">${escapeHtml(item.kanji)}</td>
                    <td>${escapeHtml(item.romaji || '‚ùå Not set')}</td>
                    <td>${item.correct}/${item.correct + item.wrong} 
                        (${item.correct + item.wrong > 0 ? Math.round(item.correct / (item.correct + item.wrong) * 100) : 0}%)
                    </td>
                    <td>
                        <button class="delete-btn" onclick="deleteKanji(${index})">üóëÔ∏è Delete</button>
                    </td>
                `;
            });
            
            document.getElementById('newKanjiInput').value = '';
            document.getElementById('newRomajiInput').value = '';
        }

        function addNewKanji() {
            const kanji = document.getElementById('newKanjiInput').value.trim();
            const romaji = document.getElementById('newRomajiInput').value.trim();
            
            if (!kanji) return alert('Please enter a kanji!');
            
            if (gameData.some(item => item.kanji === kanji)) {
                return alert('Kanji already exists!');
            }
            
            gameData.push({
                kanji,
                romaji: romaji || '',
                correct: 0,
                wrong: 0
            });
            
            sessionStorage.setItem('kanjiGameItems', JSON.stringify(gameData));
            loadKanjiListTable();
        }

        function deleteKanji(index) {
            if (confirm('Delete this kanji?')) {
                gameData.splice(index, 1);
                sessionStorage.setItem('kanjiGameItems', JSON.stringify(gameData));
                loadKanjiListTable();
            }
        }

        function clearAllData() {
            if (confirm('Clear ALL data? This cannot be undone.')) {
                sessionStorage.removeItem('kanjiGameItems');
                gameData = [];
                loadKanjiListTable();
            }
        }

        function loadRomajiEditTable() {
            if (gameData.filter(item => !item.romaji).length === 0) {
                startGame();
                return;
            }
            
            const itemsWithoutRomaji = gameData.filter(item => !item.romaji);
            populateEditTable(itemsWithoutRomaji);
            showSection('editSection');
        }

        // 2. Romaji Edit Section
        function populateEditTable(items) {
            const tbody = document.querySelector('#editTable tbody');
            tbody.innerHTML = '';
            
            items.forEach((item) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td class="kanji-cell">${escapeHtml(item.kanji)}</td>
                    <td><input type="text" value="${escapeHtml(item.romaji)}" placeholder="e.g. taberu" style="width: 100%;"></td>
                `;
            });
        }

        function saveEditedList() {
            const itemsWithoutRomaji = gameData.filter(item => !item.romaji);
            let index = 0;
            
            document.querySelectorAll('#editTable tbody tr').forEach((row) => {
                const romajiCell = row.cells[1];
                const romajiInput = romajiCell.querySelector('input');
                
                if (romajiInput && romajiInput.value.trim()) {
                    itemsWithoutRomaji[index].romaji = romajiInput.value.trim();
                }
                index++;
            });
            
            sessionStorage.setItem('kanjiGameItems', JSON.stringify(gameData));
            startGame();
        }

        // 3. Game Logic
        let currentItem = null;
        let score = { correct: 0, total: 0 };

        function startGame() {
            const stored = sessionStorage.getItem('kanjiGameItems');
            gameData = stored ? JSON.parse(stored) : [];
            
            const itemsWithRomaji = gameData.filter(item => item.romaji);
            if (itemsWithRomaji.length === 0) {
                alert('No kanji with romaji found! Add romaji first.');
                goBackToInput();
                return;
            }
            
            score = { correct: 0, total: 0 };
            nextQuestion();
            showSection('gameSection');
        }

        function nextQuestion() {
            const itemsWithRomaji = gameData.filter(item => item.romaji);
            if (itemsWithRomaji.length === 0) {
                document.getElementById('questionArea').innerHTML = '<h3>No items with romaji!</h3>';
                return;
            }
            
            const idx = Math.floor(Math.random() * itemsWithRomaji.length);
            currentItem = { ...itemsWithRomaji[idx], index: gameData.indexOf(itemsWithRomaji[idx]) };
            
            document.getElementById('kanjiDisplay').textContent = currentItem.kanji;
            document.getElementById('answerInput').value = '';
            document.getElementById('answerInput').focus();
            document.getElementById('feedbackArea').innerHTML = '';
        }

        function checkAnswer() {
            const userAnswer = document.getElementById('answerInput').value.trim();
            if (!userAnswer) return;
            
            const normalizedUser = normalizeRomaji(userAnswer);
            const normalizedCorrect = normalizeRomaji(currentItem.romaji);
            const isCorrect = normalizedUser === normalizedCorrect;
            
            score.total++;
            if (isCorrect) {
                score.correct++;
                currentItem.correct++;
                showFeedback(`‚úÖ Correct! "${currentItem.romaji}"`, 'correct');
            } else {
                currentItem.wrong++;
                showFeedback(`‚ùå Wrong. Correct: "${currentItem.romaji}"`, 'wrong');
            }
            
            gameData[currentItem.index] = currentItem;
            sessionStorage.setItem('kanjiGameItems', JSON.stringify(gameData));
            updateScoreDisplay();
        }

        function normalizeRomaji(str) {
            return str.toLowerCase().trim().replace(/\s+/g, ' ');
        }

        function showFeedback(message, type) {
            const feedback = document.getElementById('feedbackArea');
            feedback.innerHTML = `<div class="feedback ${type}">${message}</div>`;
            setTimeout(nextQuestion, 2000);
        }

        function updateScoreDisplay() {
            const pct = score.total > 0 ? Math.round((score.correct / score.total) * 100) : 0;
            document.getElementById('scoreDisplay').textContent = 
                `Score: ${score.correct}/${score.total} (${pct}%)`;
        }

        function speakCurrentKanji() {
            if (!currentItem) return alert('No current kanji');
            
            const audio = new Audio(`https://translate.google.com/translate_tts?ie=UTF-8&tl=ja&client=tw-ob&q=${encodeURIComponent(currentItem.kanji)}`);
            audio.volume = 0.8; // Slightly quieter to avoid clipping
            
            // Multiple fallback strategies
            const tryPlay = () => {
                audio.play().catch(() => {
                    // Silent retry after 100ms
                    setTimeout(tryPlay, 100);
                });
            };
            
            audio.addEventListener('canplaythrough', tryPlay, { once: true });
            audio.addEventListener('loadstart', () => {
                console.log('Loading TTS audio...');
            });
            
            tryPlay(); // Initial attempt
        }



        function showStats() {
            const stats = gameData.map((item, i) => `
                <div>${item.kanji}: ${item.romaji || '‚ùå No romaji'} ‚Üí ${item.correct}/${item.correct + item.wrong} 
                (${item.correct + item.wrong > 0 ? Math.round(item.correct / (item.correct + item.wrong) * 100) : 0}%)
                </div>
            `).join('');
            
            document.getElementById('statsContent').innerHTML = stats;
            document.getElementById('statsModal').style.display = 'block';
        }

        function hideStats() {
            document.getElementById('statsModal').style.display = 'none';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && document.getElementById('gameSection').classList.contains('active')) {
                checkAnswer();
            }
        });

        // Load data on startup
        window.onload = function() {
            loadKanjiListTable();
        };
    </script>
</body>
</html>
